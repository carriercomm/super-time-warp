<!DOCTYPE html>
<html>
    <head>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/shared/gj_constants.js"></script>
        <script src="/shared/gj_json.js"></script>
        <script src="pixi.js"></script>
        <script src="client.js"></script>
        <style>
            body { background: #000; }
            #c { background: #fff; }
        </style>
    </head>
    <body>

    </body>
    <script>

    // Drawing ####################################################################

    var SCALE_FACTOR = 1;
    var SCALE = new PIXI.Point(SCALE_FACTOR, SCALE_FACTOR);
    PIXI.scaleModes.DEFAULT = PIXI.scaleModes.NEAREST;

    // create an new instance of a pixi stage
    var stage = new PIXI.Stage(0x66FF99);
    var root_container = new PIXI.DisplayObjectContainer();
    root_container.scale = SCALE;
    stage.addChild(root_container);

    var tile_container = new PIXI.DisplayObjectContainer();
    root_container.addChild(tile_container);

    var object_container = new PIXI.DisplayObjectContainer();
    root_container.addChild(object_container);

    // create a renderer instance
    var renderer = PIXI.autoDetectRenderer(640, 480);

    // add the renderer view element to the DOM
    document.body.appendChild(renderer.view);

    // create a texture from an image path
    var texture = PIXI.Texture.fromImage('assets/tile.png');

    var player_texture = PIXI.Texture.fromImage('assets/player.png');

    var sprites = {};
    function initSprites(state) {
        var tiles = state.maps[state.era].tiles;
        for (var i = 0; i < tiles.length; i++) {
            for (var j = 0; j < tiles[i].length; j++) {
                if (!tiles[i][j]) continue;

                // create a new Sprite using the texture
                var tile = new PIXI.Sprite(texture);

                // move the sprite into position
                tile.position.x = j * 16;
                tile.position.y = i * 16;

                tile_container.addChild(tile);
            }
        }
    }

    function renderState(state) {

        for (var i = 0; i < state.objects.length; i++) {
            var object = state.objects[i];
            var sprite = sprites[object.id];
            if (!sprite) {

                sprite = new PIXI.Sprite(player_texture);

                // center the sprites anchor point
                sprite.anchor.x = 0.5;
                sprite.anchor.y = 1;

                sprites[object.id] = sprite;
                object_container.addChild(sprite);
            }
            sprite.position.y = object.y;
            sprite.position.x = object.x;
            sprite.rotation = (object.angle * Math.PI) / 180;
        }

        // render the stage
        renderer.render(stage);
    }

    // Networking #################################################################

        (function(){
            var socket = io();
            var latestState;

            socket.on('msg state', function(state) {
                latestState = state;
                initSprites(latestState);
                renderState(latestState);
            });

            socket.on('msg diff', function(diff) {
                latestState = gj_JSON.applyDiff(latestState, diff);
                renderState(latestState);
            });

            var keys = [];
            for (var key in gj_CONSTANTS.keys) {
                keys.push(gj_CONSTANTS.keys[key]);
            }

            window.onkeyup = function(e) {
                if (keys.indexOf(e.keyCode) > -1) {
                    socket.emit('msg input', { type: 'keyup', key: e.keyCode });
                }
            };

            window.onkeydown = function(e) {
                if (keys.indexOf(e.keyCode) > -1) {
                    socket.emit('msg input', { type: 'keydown', key: e.keyCode });
                }
            };

            window.onmousemove = function(e) {
                socket.emit('msg input', { type: 'mousemove', x: e.x, y: e.y });
            };

            window.onmousedown = function(e) {
                socket.emit('msg input', { type: 'mousedown' });
            };

            window.onmouseup = function(e) {
                socket.emit('msg input', { type: 'mouseup' });
            };

        })();

    </script>
</html>
